<!--
Copyright (c) 2014, adenin TECHNOLOGIES
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!--
@group Polymer Core Elements
The `core-ajax` element exposes network request functionality.
    <core-ajax
        auto
        url="http://gdata.youtube.com/feeds/api/videos/"
        params='{"alt":"json", "q":"chrome"}'
        handleas="json"
        on-response="{{handleResponse}}"></core-ajax>

With `auto` set to `true`, the element performs a request whenever
its `url`, `params` or `body` properties are changed. Automatically generated
requests will be debounced in the case that multiple attributes are changed
sequentially.

Note: The `params` attribute must be double quoted JSON.
You can trigger a request explicitly by calling `generateRequest` on the
element.

@element core-ajax
@status preview
@homepage github.io
-->
<link rel="import" href="at-core-request.html">
<link rel="import" href="../at-core-spinner/at-core-spinner.html">
<link rel="import" href="../at-carbon-message/at-carbon-message.html">

<dom-module id="at-core-activity">
  <template>
    <at-carbon-message id="msg" type="error"></at-carbon-message>
    <at-core-spinner id="spinner" type="wave" display="none"></at-core-spinner>
  </template>
</dom-module>
<script>

Polymer({
    is:"at-core-activity",
  
    /**
    * Fired when a response is received.
    *
    * @event core-response
    */

    /**
    * Fired when an error is received.
    *
    * @event core-error
    */

    /**
    * Fired whenever a response or an error is received.
    *
    * @event core-complete
    */
    
    properties:{
        /**
        * The URL target of the request.
        */
        url: {
            type: String,
            value: '',
            observer: 'urlChanged'
        },
        
        /**
        * Parameters to send to the specified URL, as JSON.
        * @type string (JSON)
        */
        params:{
            type: Object,
            value: {},
            observer:'requestOptionsChanged'
        },
        
        /**
        * The HTTP method to use such as 'GET', 'POST', 'PUT', or 'DELETE'.
        * Default is 'GET'.
        */
        method: {
            type: String,
            value: 'GET',
            observer:'requestOptionsChanged'
        },
        
        /**
        * HTTP request headers to send.
        *
        * Example:
        *
        *     <at-core-activity
        *         auto
        *         url="http://somesite.com"
        *         headers='{"X-Requested-With": "XMLHttpRequest"}'
        *         handleAs="json"
        *         on-core-response="{{handleResponse}}"></at-core-activity>
        */
        headers: {
            type: Object,
            value: {},
            observer:'requestOptionsChanged'
        },
        
        /**
        * Specifies what data to store in the `response` property, and
        * to deliver as `event.response` in `response` events.
        *
        * One of:
        *
        *    `text`: uses `XHR.responseText`.
        *
        *    `xml`: uses `XHR.responseXML`.
        *
        *    `json`: uses `XHR.responseText` parsed as JSON.
        *
        *    `arraybuffer`: uses `XHR.response`.
        *
        *    `blob`: uses `XHR.response`.
        *
        *    `document`: uses `XHR.response`.
        */
        handleAs: {
            type: String,
            value :'json',
            observer:'requestOptionsChanged'
        },

        /**
        * If true, error messages will automatically be logged to the console.
        */
        verbose: {
            type: Boolean,
            value: false
        },
        
        /**
        * If true, automatically performs an Ajax request when either `url` or `params` changes.
        */
        auto: {
            type: Boolean,
            value: false,
            observer: 'requestOptionsChanged'
        },

        /**
        * Optional raw body content to send when method === "POST".
        *
        * Example:
        *
        *     <core-ajax method="POST" auto url="http://somesite.com"
        *         body='{"foo":1, "bar":2}'>
        *     </core-ajax>
        *
        * @attribute body
        * @type Object
        * @default undefined
        */
        body: {
            type: String,
            value: 'undefined',
            observer:'requestOptionsChanged'
        },
        
        /**
        * Toggle whether XHR is synchronous or asynchronous. Don't change this
        * to true unless You Know What You Are Doingâ„¢.
        *
        */
        sync: {
            type: Boolean,
            value: false,
            observer:'requestOptionsChanged'
        },
        
        /**
        * Content type to use when sending data.
        */
        contentType:{
            type: String,
            value: 'application/x-www-form-urlencoded',
            observer:'requestOptionsChanged'
        },

        /**
        * Set the withCredentials flag on the request.
        */
        withCredentials:{
            type: Boolean,
            value: false,
            observer:'requestOptionsChanged'
        },
         
        /**
        * Will be set to the most recent request made by this core-ajax element.
        *
        * @type core-request
        */
        lastRequest: {
            type: Object,
            value: null,
            notify: true
        },
        
        /**
        * Will be set to the most recent response received by a request
        * that originated from this core-ajax element. The type of the response
        * is determined by the value of `handleas` at the time that the request
        * was generated.
        *
        * @type *
        */
        lastResponse: {
            type: Object,
            value: null,
            notify: true
        },
        
        /**
        * Will be set to the most recent error that resulted from a request
        * that originated from this core-ajax element.
        *
        * @type Error
        */
        lastError: {
            type: Object,
            value: null,
            notify: true
        },
        
        /**
        * An Array of all in-flight requests originating from this core-ajax
        * element.
        */
        activeRequests: {
            type: Array,
            value: [],
            notify: true
        } 
    },
    
    ready: function () {
        this._afterReady = true;
        this.requestOptionsChanged();
    },

    get queryString () {
        var queryParts = [];
        var param;
        var value;
        for (param in this.params) {
            value = this.params[param];
            param = window.encodeURIComponent(param);
            if (value !== null) {
                param += '=' + window.encodeURIComponent(value);
            }
            queryParts.push(param);
        }
      return queryParts.join('&');
    },
    
    get requestUrl () {
        var queryString = this.queryString;
        if (queryString) {
            return this.url + '?' + queryString;
        }
        return this.url;
    },
    
    get requestHeaders () {
        var headers = Object.create(this.headers || {});
        if (!('content-type' in headers)) {
            headers['content-type'] = this.contentType;
        }
        return headers;
    },

    toRequestOptions: function () {
        return {
            url: this.requestUrl,
            method: this.method,
            headers: this.requestHeaders,
            body: this.body,
            async: !this.sync,
            handleAs: this.handleAs,
            withCredentials: this.withCredentials
        };
    },
    
    urlChanged: function () {
        if (!this.handleAs) {
            var ext = String(this.url).split('.').pop();
            switch (ext) {
                case 'json':
                    this.handleAs = 'json';
                    break;
                }
        }
        this.requestOptionsChanged();
    },
    
    requestOptionsChanged: function () {
        if (!this._afterReady) {
            return;
        }
      
        if (this.auto) {
            this.debounce('autoGenerateRequest', this.generateRequest);
        }
    },
    
    /**
     * Performs an AJAX request to the specified URL.
     *
     * @method generateRequest
     */
    generateRequest: function () {
        this.$.msg.html = "";
        
        var request = document.createElement('at-core-request');
        var requestOptions = this.toRequestOptions();
        this.activeRequests.push(request);
        request.completes.then(
            this.handleResponse.bind(this),
            this.handleError.bind(this)
        ).then(
            this.discardRequest.bind(this, request)
        );
        
        this.$.spinner.display = "block";
        
        request.send(requestOptions);
        this.lastRequest = request;
        this.fire('request', {
            xhr: request.xhr,
            options: requestOptions
        });
        return request;
    },
    
    handleResponse: function (response) {
        this.lastResponse = response;
        this.fire('core-response', response);
    },
    
    handleError: function (error) {
        if (this.verbose) {
            console.error(error);
        }
        this.lastError = error;
        this.fire('core-error', error);
    },
    
    discardRequest: function (request) {
        this.$.spinner.display = "none";
        
        var requestIndex = this.activeRequests.indexOf(request);
        if (requestIndex > 0) {
            this.activeRequests.splice(requestIndex, 1);
        }
        
        debugger;
        this.fire('core-complete', { response: request.xhr.status, xhr: request.xhr });
    }
});

</script>
